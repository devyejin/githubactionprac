# workflow ì´ë¦„
name: deploy service

# ì›Œí¬í”Œë¡œìš°ë¥¼ ìë™ìœ¼ë¡œ ì‹¤í–‰í•  ì´ë²¤íŠ¸ë¥¼ ì •ì˜
on:
  # main ë¸Œëœì¹˜ì— pushë¼ëŠ” ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œ ì‘ì—…ì„ ì‹¤í–‰í•˜ê² ë‹¤
  push:
    branches:
      - main

#ì‹¤í–‰ë  ì‘ì—…ë“¤ì„ ì •ì˜
jobs:
  # ì‘ì—… ì´ë¦„
  deploy:
    # ì‘ì—…ì´ ë°œìƒë  Guthub Workspace ì‹¤í–‰ í™˜ê²½
    runs-on: ubuntu-24.04

    #ì‹¤ì œë¡œ ì‹¤í–‰ë  ì‘ì—… ë‚´ë¶€ ë‹¨ê³„
    steps:
      # ë‚´ ì›ê²©ì €ì¥ì†Œ(repo)ì— ìˆëŠ” í”„ë¡œì íŠ¸ë¥¼ Workspaceë¡œ ê°€ì ¸ì˜¨ë‹¤
      - name: Checkout code
        uses: actions/checkout@v4

      # ì•¡ì…˜ ì‹œì‘ ì•Œë¦¼ ë©”ì„¸ì§€
      - name: Start Message
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: : ğŸš€ "ë°°í¬ ì‹œì‘"

      # ìºì‹œ ì €ì¥ ì„¤ì •ì„ ìœ„í•œ action(ë¼ì´ë¸ŒëŸ¬ë¦¬)
      - name: Cache Docker Image Layer
        # actions/cache : ê¹ƒí—ˆë¸Œ ìºì‹œ ì €ì¥ì†Œ í™œìš©ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
        uses: actions/cache@v4.2.0
        with:
          # docker-composeì—ì„œ ì •ì˜í•´ë†“ì€ ê²½ë¡œ
          path: /tmp/.build-cache
          # workspaceì˜ cache ì €ì¥ê³µê°„ì— ë‹¤ì–‘í•œ cacheê°€ ì €ì¥ë˜ë¯€ë¡œ ì‹ë³„í•˜ëŠ” ì‹ë³„ì
          # ìºì‹±ì„ ì˜¤ë²„ë¼ì´ë”©í•˜ëŠ”ê²Œ ì•„ë‹ˆë¼ ìŒ“ì´ë¯€ë¡œ ë³„ê°œì˜ ì´ë¦„ì„ ì§€ì •í•´ì¤˜ì•¼ í•¨
          key: docker-image-layer-cache-${{ github.sha }}
          restore-keys: docker-image-layer-cache

      # ssh ê´€ë¦¬ë¥¼ ì‰½ê²Œ í•˜ê¸° ìœ„í•´ ssh-agent ë¥¼ ì‚¬ìš©
      - name: run ssh-agnet
        # action ì‚¬ìš©ë²•ì€ í•´ë‹¹ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ë©° ì‚¬ìš©í•´ì•¼ í•¨
        # ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬(?)ë¥¼ ê°œë°œí•œ ì‚¬ëŒì´ ê·œì •í•œ ë¬¸ë²•ì´ë‹ˆ ì§€ì¼œì•¼ í•¨
        # Make sure the @v0.9.0 matches the current version of the action
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Guthub Actions Workspaceì…ì¥ì—ì„œ EC2ì™€ì˜ FINGERPRINT ì‘ì—…ì´ í•„ìš”(ë¯¿ì„ ìˆ˜ ìˆëŠ” í™˜ê²½ì´ë‹ˆ?)
      - name: Add Remote Server Fingerprint to Known Hosts
        # ë‚´ repoì— ë“±ë¡í•´ ë†“ì€ í‚¤ë¥¼ known_hosts (Guthub Actions Workspaceì—ì„œ ì›ê²© ì„œë²„ë“¤ì˜ ì§€ë¬¸ì„ ì €ì¥í•˜ëŠ” ê³µê°„) ì—ë‹¤ê°€ ì €ì¥
        run: ssh-keyscan -H -p ${{secrets.SSH_PORT}} ${{secrets.SSH_HOST}} >> ~/.ssh/known_hosts || true

      # 1. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‚´ìš©ì„ ì‘ì„±í•œë‹¤
      - name: Create .env file
        run: |
          echo "DATABASE_HOST=${{ secrets.DATABASE_HOST }}" >> .env
          echo "DATABASE_NAME=${{ secrets.DATABASE_NAME }}" >> .env
          echo "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" >> .env
          echo "DATABASE_PORT=${{ secrets.DATABASE_PORT }}" >> .env
          echo "DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}" >> .env
          echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}" >> .env
          echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> .env
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> .env

      # ë„ì»¤ Buildkit ì—”ì§„ ì„¤ì • action(ë¼ì´ë¸ŒëŸ¬ë¦¬)
      - name: Set up Docker Buildx
        # setup-buildx-action : ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì— Buildkit ì—”ì§„ì„ ì„¤ì¹˜í•˜ëŠ” action(ë¼ì´ë¸ŒëŸ¬ë¦¬)
        # buildx = BuildKit
        uses: docker/setup-buildx-action@v3

      # BuildKit ì—”ì§„ ë¹Œë”(ì´ë¯¸ì§€ ë¹Œë“œë¥¼ ë„ì™€ì£¼ëŠ” ë„êµ¬) ìƒì„± -
      # -> ê¸°ì¡´ ë„ì»¤ ë¹Œë” :  Cache íŒŒì¼ ì €ì¥&ë¶ˆëŸ¬ì˜¤ê¸° ê²½ë¡œë¥¼ ê°œë°œìê°€ ì œì–´ ë¶ˆê°€ so, buildkitì´ ë§Œë“  ë¹Œë”ë¥¼ ì‚¬ìš©
      # - name: Create Buildkit Bulder
      #   # 1. ë¹Œë”(buildkit)ë¥¼ ìƒì„±í•˜ëŠ” ëª…ë ¹ì–´
      #   # 2. ë¹Œë”(buildkit) ì„¤ì • ëª…ë ¹ì–´
      #   run: |
      #     docker buildx create --use --name buildkit
      #     docker buildx use buildkit

      # checkout í•´ì˜¨ í”„ë¡œì íŠ¸ë¥¼ ì´ë¯¸ì§€ë¡œ ë¹Œë“œí•˜ê² ë‹¤. (ë¹Œë“œí•  ë•Œ í™˜ê²½ë³€ìˆ˜ê°€ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‚¬ì „ì‘ì—…ìœ¼ë¡œ ìƒì„±)
      - name: Docker Image Build
        # ëª…ë ¹ì–´ ì²´ê³„ê°€ ë‹¤ë¥´ë‹¤ docker-compose ì•„ë‹˜
        # ë¹Œë”ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ  íŒŒì¼ëª…ì´ ë³€ê²½ë˜ì–´ì•¼ í•¨
        run: docker compose -f docker-compose-actions-cache.yml build --build-arg BUILDKIT_INLINE_CACHE=1

      - name: Login DockerHub
        run: echo '${{ secrets.DOCKER_PASSWORD }}' | docker login -u '${{ secrets.DOCKER_USERNAME }}' --password-stdin

      # ë¹Œë“œ -> ë¡œê·¸ì¸ -> push
      - name: Docker Image Push
        run: docker compose -f docker-compose-actions-cache.yml push

      # .env ì™€ docker-compose.yml íŒŒì¼ë“¤ì„ ec2ì˜ ~/work-directoryë¡œ ë³µì‚¬í•œë‹¤, secure ì´ìš©í•´ì„œ
      # why? ec2ì—ì„œ ì´ë¯¸ì§€ë¥¼ pullí•´ì™€ì„œ docker-compose up í•˜ê¸°ìœ„í•´ í•„ìš”í•˜ë‹ˆê¹Œ
      # ë³´ì•ˆëœ ìƒíƒœë¡œ ë³µì‚¬í•˜ëŠ” ì‘ì—…ì´ë¼ scp-action
      - name: Copy .env ì™€ docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "docker-compose-actions-cache.yml, .env"
          target: "~/work-directory"

      # ssh ëª…ë ¹ì„ í•˜ëŠ”ê±°ë¼ ssh-action
      - name: Pull Image & Up Container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          # -f ì˜µì…˜, defaultê°€ ì•„ë‹Œ docker-compose.yml íŒŒì¼ëª… ëª…ì‹œí•  ë•Œ
          script: |
            cd ~/work-directory
            docker-compose -f docker-compose-actions-cache.yml  pull
            docker-compose -f docker-compose-actions-cache.yml down
            docker-compose -f docker-compose-actions-cache.yml up -d

      # Discord ì•Œë¦¼ - ë°°í¬ ì„±ê³µ
      - name: End Message - Success
        uses: sarisia/actions-status-discord@v1
        if: success()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: :"ğŸ‘ ë°°í¬ ì¢…ë£Œ - ì„±ê³µ"
          color: 0x7aa3f4

      # Discord ì•Œë¦¼ - ë°°í¬ ì‹¤íŒ¨
      - name: End Message - failure
        uses: sarisia/actions-status-discord@v1
        if: failure()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: :"âŒ ë°°í¬ ì¢…ë£Œ -  ì‹¤íŒ¨"
          color: 0xf697d2

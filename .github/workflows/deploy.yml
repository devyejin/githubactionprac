# workflow ì´ë¦„
name: deploy service

# ì›Œí¬í”Œë¡œìš°ë¥¼ ìë™ìœ¼ë¡œ ì‹¤í–‰í•  ì´ë²¤íŠ¸ë¥¼ ì •ì˜
on:
  # main ë¸Œëœì¹˜ì— pushë¼ëŠ” ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œ ì‘ì—…ì„ ì‹¤í–‰í•˜ê² ë‹¤
  push:
    branches:
      - main

#ì‹¤í–‰ë  ì‘ì—…ë“¤ì„ ì •ì˜
jobs:
  # ì‘ì—… ì´ë¦„
  deploy:
    # ì‘ì—…ì´ ë°œìƒë  Guthub Actionsì‹¤í–‰ í™˜ê²½(workspace)
    runs-on: ubuntu-24.04

    #ì‹¤ì œë¡œ ì‹¤í–‰ë  ì‘ì—… ë‚´ë¶€ ë‹¨ê³„
    steps:
      # ë‚´ ì›ê²©ì €ì¥ì†Œ(repo)ì— ìˆëŠ” í”„ë¡œì íŠ¸ë¥¼ Workspaceë¡œ ê°€ì ¸ì˜¨ë‹¤
      - name: Checkout code
        uses: actions/checkout@v4

      # ì•¡ì…˜ ì‹œì‘ ì•Œë¦¼ ë©”ì„¸ì§€
      - name: Start Message
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ğŸš€ ë°°í¬ ì‹œì‘"

      # ìºì‹œ ì €ì¥ ì„¤ì •ì„ ìœ„í•œ action(ë¼ì´ë¸ŒëŸ¬ë¦¬)
      - name: Cache Docker Image Layer
        # actions/cache :  GitHub Actions ìºì‹œ ì €ì¥ì†Œ í™œìš©ì„ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
        uses: actions/cache@v4.2.0
        with:
          # cacheê°€ ì €ì¥ë  ê²½ë¡œë¥¼ ì •ì˜ (docker-compose.ymlì—ì„œ) 
          #build ë  ë•Œ í•´ë‹¹ ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ë©´ ì´ë¯¸ì§€ ë ˆì´ì–´ ìºì‹œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ)
          path: /tmp/.build-cache
          # Github Actions cache ì €ì¥ê³µê°„ì— ë‹¤ì–‘í•œ cacheê°€ ì €ì¥ë˜ë¯€ë¡œ ì‹ë³„ì í•„ìš”
          # ìºì‹±ì„ ì˜¤ë²„ë¼ì´ë”©í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ìƒˆë¡œìš´ ìºì‹œë¥¼ ì¶”ê°€í•˜ë¯€ë¡œ ë³„ê°œì˜ ì´ë¦„ì„ ì§€ì •í•´ì•¼ í•¨
          # uuidì™€ ê°™ì€ ê°’ì„ ë¶™ì„
          key: docker-image-layer-cache-${{ github.sha }}
          restore-keys: docker-image-layer-cache

      # ssh ê´€ë¦¬ë¥¼ ì‰½ê²Œ í•˜ê¸° ìœ„í•´ ssh-agent ë¥¼ ì‚¬ìš©
      - name: run ssh-agnet
        #SSH Agentë¥¼ ì‹¤í–‰í•´ private keyë¥¼ ì‚¬ìš©í•´ì„œ ì›ê²© ì„œë²„ì™€ ì—°ê²°
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Guthub Actions Workspaceì…ì¥ì—ì„œ EC2ì™€ì˜ FINGERPRINT ì‘ì—…ì´ í•„ìš”(ë¯¿ì„ ìˆ˜ ìˆëŠ” í™˜ê²½ì¸ì§€ í™•ì¸)
      - name: Add Remote Server Fingerprint to Known Hosts
        # ë‚´ repoì— ë“±ë¡í•´ ë†“ì€ í‚¤ë¥¼ known_hostsì— ì¶”ê°€í•˜ì—¬ ì›ê²© ì„œë²„ì™€ì˜ ì‹ ë¢° ê´€ê³„ë¥¼ ë§ºëŠ”ë‹¤
        # ë§Œì•½ falseë¼ë©´ ì´í›„ ì‘ì—… ìˆ˜í–‰ x
        run: ssh-keyscan -H -p ${{secrets.SSH_PORT}} ${{secrets.SSH_HOST}} >> ~/.ssh/known_hosts || true

      # 1. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‚´ìš©ì„ ì‘ì„±í•œë‹¤
      - name: Create .env file
        run: |
          echo "DATABASE_HOST=${{ secrets.DATABASE_HOST }}" >> .env
          echo "DATABASE_NAME=${{ secrets.DATABASE_NAME }}" >> .env
          echo "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" >> .env
          echo "DATABASE_PORT=${{ secrets.DATABASE_PORT }}" >> .env
          echo "DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}" >> .env
          echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}" >> .env
          echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> .env
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> .env

      # Docker BuildKit ì—”ì§„ ì„¤ì • action(ë¼ì´ë¸ŒëŸ¬ë¦¬)
      - name: Set up Docker Buildx
        # setup-buildx-action : ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì— Buildkit ì—”ì§„ì„ ì„¤ì¹˜í•˜ëŠ” action(ë¼ì´ë¸ŒëŸ¬ë¦¬)
        # buildx = BuildKit
        uses: docker/setup-buildx-action@v3

      # BuildKit ì—”ì§„ ë¹Œë”(ì´ë¯¸ì§€ ë¹Œë“œë¥¼ ë„ì™€ì£¼ëŠ” ë„êµ¬) ìƒì„±
      # -> ê¸°ì¡´ ë„ì»¤ ë¹Œë” :  Cache íŒŒì¼ ì €ì¥&ë¶ˆëŸ¬ì˜¤ê¸° ê²½ë¡œë¥¼ ê°œë°œìê°€ ì œì–´ ë¶ˆê°€ so, buildkitì´ ë§Œë“  ë¹Œë”ë¥¼ ì‚¬ìš©
      - name: Create Buildkit Bulder
        # 1. ë¹Œë”(buildkit)ë¥¼ ìƒì„±í•˜ëŠ” ëª…ë ¹ì–´
        # 2. ë¹Œë”(buildkit) ì„¤ì • ëª…ë ¹ì–´
        run: |
          docker buildx create --use --name buildkit
          docker buildx use buildkit

      # checkout í•´ì˜¨ í”„ë¡œì íŠ¸ë¥¼ ì´ë¯¸ì§€ë¡œ ë¹Œë“œí•˜ê² ë‹¤. (ë¹Œë“œí•  ë•Œ í™˜ê²½ë³€ìˆ˜ê°€ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‚¬ì „ì‘ì—…ìœ¼ë¡œ ìƒì„±)
      - name: Docker Image Build
        # workspaceì—ì„œì˜ ëª…ë ¹ì–´ ì²´ê³„ê°€ ë‹¤ë¥´ë‹¤ docker-compose ëŒ€ì‹  docker compose ì‚¬ìš© (BuildKit ì—”ì§„ ë„ì… ì „)
        # ë¹Œë”ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ  --build-arg BUILDKIT_INLINE_CACHE=1 ì˜µì…˜ í•„ìš”
        # docker-compose.yml íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ default ì‚¬ìš©ì‹œì—ëŠ” ëª…ì‹œí•˜ì§€ ì•Šì§€ë§Œ ì´ì œ -f ì˜µì…˜ê³¼ íŒŒì¼ëª… ê¸°ì¬í•´ì¤˜ì•¼ í•¨
        # ë¹Œë“œì‹œ, BUILDKIT_INLINE_CACHE=1 ì¸ìë¥¼ ë„˜ê²¨ì¤Œìœ¼ë¡œ ì¨ buildkitì„ ì‚¬ìš©í•˜ì—¬ ë¹Œë“œ ìºì‹œë¥¼ í™œì„±í™”
        # ìºì‹œëœ ë ˆì´ì–´ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ ì¬ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •
        # 0ìœ¼ë¡œ ì„¤ì •ì‹œ, ìºì‹œ ê¸°ëŠ¥ì„ ë¹„í™œì„±í™”í•˜ê³  ë§¤ë²ˆ ìƒˆë¡œ ë¹Œë“œ
        run: docker compose -f docker-compose-actions-cache.yml build --build-arg BUILDKIT_INLINE_CACHE=1

      - name: Login DockerHub
        run: echo '${{ secrets.DOCKER_PASSWORD }}' | docker login -u '${{ secrets.DOCKER_USERNAME }}' --password-stdin

      # ë¹Œë“œ -> ë¡œê·¸ì¸ -> push
      - name: Docker Image Push
        run: docker compose -f docker-compose-actions-cache.yml push

      # .env ì™€ docker-compose.yml íŒŒì¼ë“¤ì„ ec2ì˜ ~/work-directoryë¡œ ë³µì‚¬í•œë‹¤, secure ì´ìš©í•´ì„œ
      # why? ec2ì—ì„œ ì´ë¯¸ì§€ë¥¼ pullí•´ì™€ì„œ docker-compose up í•˜ê¸°ìœ„í•´ í•„ìš”í•˜ë‹ˆê¹Œ
      # ë³´ì•ˆëœ ìƒíƒœë¡œ ë³µì‚¬í•˜ëŠ” ì‘ì—…ì´ë¼ scp-action
      - name: Copy .env ì™€ docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "docker-compose-actions-cache.yml, .env"
          target: "~/work-directory"

      # ssh ëª…ë ¹ì–´ë¥¼ í†µí•´ ì›ê²© ì„œë²„ì—ì„œ Docker Composeë¥¼ ì‹¤í–‰
      - name: Pull Image & Up Container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          # -f ì˜µì…˜, defaultê°€ ì•„ë‹Œ docker-compose.yml íŒŒì¼ëª… ëª…ì‹œí•  ë•Œ
          script: |
            cd ~/work-directory
            docker-compose -f docker-compose-actions-cache.yml  pull
            docker-compose -f docker-compose-actions-cache.yml down
            docker-compose -f docker-compose-actions-cache.yml up -d

      # Discord ì•Œë¦¼ - ë°°í¬ ì„±ê³µ
      - name: End Message - Success
        uses: sarisia/actions-status-discord@v1
        if: success()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: :"ğŸ‘ ë°°í¬ ì¢…ë£Œ - ì„±ê³µ"
          color: 0x7aa3f4

      # Discord ì•Œë¦¼ - ë°°í¬ ì‹¤íŒ¨
      - name: End Message - failure
        uses: sarisia/actions-status-discord@v1
        if: failure()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: :"âŒ ë°°í¬ ì¢…ë£Œ -  ì‹¤íŒ¨"
          color: 0xf697d2

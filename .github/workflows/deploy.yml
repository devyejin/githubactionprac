# workflow ì´ë¦„
name: deploy service

# ì›Œí¬í”Œë¡œìš°ë¥¼ ìë™ìœ¼ë¡œ ì‹¤í–‰í•  ì´ë²¤íŠ¸ë¥¼ ì •ì˜
on:
  # main ë¸Œëœì¹˜ì— pushë¼ëŠ” ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œ ì‘ì—…ì„ ì‹¤í–‰í•˜ê² ë‹¤
  push:
    branches:
      - main

#ì‹¤í–‰ë  ì‘ì—…ë“¤ì„ ì •ì˜
jobs:
  ssh-agent:
    # ì‘ì—…ì´ ë°œìƒë  Guthub Workspace ì‹¤í–‰ í™˜ê²½
    runs-on: ubuntu-24.04

    #ì‹¤ì œë¡œ ì‹¤í–‰ë  ì‘ì—… ë‚´ë¶€ ë‹¨ê³„
    steps:
      # ì•¡ì…˜ ì‹œì‘ ì•Œë¦¼ ë©”ì„¸ì§€
      - name: Start Message
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: :"ë°°í¬ ì‹œì‘"
          username: yejinoh58

      # ë‚´ ì›ê²©ì €ì¥ì†Œ(repo)ì— ìˆëŠ” í”„ë¡œì íŠ¸ë¥¼ Workspaceë¡œ ê°€ì ¸ì˜¨ë‹¤
      - name: Checkout code
        uses: actions/checkout@v4

      # ssh ê´€ë¦¬ë¥¼ ì‰½ê²Œ í•˜ê¸° ìœ„í•´ ssh-agent ë¥¼ ì‚¬ìš©
      - name: run ssh-agnet
        # action ì‚¬ìš©ë²•ì€ í•´ë‹¹ ë¬¸ì„œë¥¼ ì°¸ê³ í•˜ë©° ì‚¬ìš©í•´ì•¼ í•¨
        # ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬(?)ë¥¼ ê°œë°œí•œ ì‚¬ëŒì´ ê·œì •í•œ ë¬¸ë²•ì´ë‹ˆ ì§€ì¼œì•¼ í•¨
        # Make sure the @v0.9.0 matches the current version of the action
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Guthub Actions Workspaceì…ì¥ì—ì„œ EC2ì™€ì˜ FINGERPRINT ì‘ì—…ì´ í•„ìš”(ë¯¿ì„ ìˆ˜ ìˆëŠ” í™˜ê²½ì´ë‹ˆ?)
      - name: Add Remote Server Fingerprint to Known Hosts
        # ë‚´ repoì— ë“±ë¡í•´ ë†“ì€ í‚¤ë¥¼ known_hosts (Guthub Actions Workspaceì—ì„œ ì›ê²© ì„œë²„ë“¤ì˜ ì§€ë¬¸ì„ ì €ì¥í•˜ëŠ” ê³µê°„) ì—ë‹¤ê°€ ì €ì¥
        run: ssh-keyscan -H -p ${{secrets.SSH_PORT}} ${{secrets.SSH_HOST}} >> ~/.ssh/known_hosts || true

      # 1. í™˜ê²½ë³€ìˆ˜ íŒŒì¼ì„ ìƒì„±í•˜ê³  ë‚´ìš©ì„ ì‘ì„±í•œë‹¤
      - name: Create .env file
        run: |
          echo "DATABASE_HOST=${{ secrets.DATABASE_HOST }}" >> .env
          echo "DATABASE_NAME=${{ secrets.DATABASE_NAME }}" >> .env
          echo "DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}" >> .env
          echo "DATABASE_PORT=${{ secrets.DATABASE_PORT }}" >> .env
          echo "DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}" >> .env
          echo "MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}" >> .env
          echo "MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}" >> .env
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> .env

      # checkout í•´ì˜¨ í”„ë¡œì íŠ¸ë¥¼ ì´ë¯¸ì§€ë¡œ ë¹Œë“œí•˜ê² ë‹¤. (ë¹Œë“œí•  ë•Œ í™˜ê²½ë³€ìˆ˜ê°€ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì‚¬ì „ì‘ì—…ìœ¼ë¡œ ìƒì„±)
      - name: Docker Image Build
        # ëª…ë ¹ì–´ ì²´ê³„ê°€ ë‹¤ë¥´ë‹¤ docker-compose ì•„ë‹˜
        run: docker compose build

      - name: Login DockerHub
        run: echo '${{ secrets.DOCKER_PASSWORD }}' | docker login -u '${{ secrets.DOCKER_USERNAME }}' --password-stdin

      # ë¹Œë“œ -> ë¡œê·¸ì¸ -> push
      - name: Docker Image Push
        run: docker compose push

      # .env ì™€ docker-compose.yml íŒŒì¼ë“¤ì„ ec2ì˜ ~/work-directoryë¡œ ë³µì‚¬í•œë‹¤, secure ì´ìš©í•´ì„œ
      # why? ec2ì—ì„œ ì´ë¯¸ì§€ë¥¼ pullí•´ì™€ì„œ docker-compose up í•˜ê¸°ìœ„í•´ í•„ìš”í•˜ë‹ˆê¹Œ
      # ë³´ì•ˆëœ ìƒíƒœë¡œ ë³µì‚¬í•˜ëŠ” ì‘ì—…ì´ë¼ scp-action
      - name: Copy .env ì™€ docker-compose.yml
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "docker-compose.yml, .env"
          target: "~/work-directory"

      # ssh ëª…ë ¹ì„ í•˜ëŠ”ê±°ë¼ ssh-action
      - name: Pull Image & Up Container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          # ì‹¤í–‰í•  ëª…ë ¹ì–´ë“¤ì„ ì‘ì„±
          # multiple commandlines ì¸ ê²½ìš° | ì‚¬ìš©
          script: |
            cd ~/work-directory
            docker-compose pull
            docker-compose down
            docker-compose up -d
      
      # Discord ì•Œë¦¼ - ë°°í¬ ì„±ê³µ
      - name: End Message - Success
        uses: sarisia/actions-status-discord@v1
        if: success()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: :"ğŸ‘ ë°°í¬ ì¢…ë£Œ - ì„±ê³µ"
      
      # Discord ì•Œë¦¼ - ë°°í¬ ì‹¤íŒ¨
      - name: End Message - failure
        uses: sarisia/actions-status-discord@v1
        if: failure()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: :"âŒ ë°°í¬ ì¢…ë£Œ -  ì‹¤íŒ¨"
          
